<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Memo - TESDA MBMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for select elements */
        select {
            scrollbar-width: thin;
            scrollbar-color: #0ea5e9 #e0f2fe;
        }
        select::-webkit-scrollbar {
            width: 8px;
        }
        select::-webkit-scrollbar-track {
            background: #e0f2fe;
            border-radius: 4px;
        }
        select::-webkit-scrollbar-thumb {
            background-color: #0ea5e9;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="max-w-5xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="icons/both.png" alt="TESDA Logo" class="h-16 w-auto">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Create New Memo</h1>
                    <p class="mt-1 text-sm text-gray-500">Fill out the form below to create a new memo</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <img src="icons/blogo.png" alt="RO7 Logo" class="h-16 w-auto">
                <button onclick="window.history.back()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Back
                </button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"></div>
                <p class="text-gray-700 font-medium">Processing...</p>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="errorMessage" class="hidden mb-6 p-4 border-l-4 border-red-500 bg-red-50 rounded-r-lg shadow-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-lucide="alert-circle" class="h-5 w-5 text-red-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700 font-medium"></p>
                </div>
            </div>
        </div>

        <div id="successMessage" class="hidden mb-6 p-4 border-l-4 border-green-500 bg-green-50 rounded-r-lg shadow-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-green-700 font-medium"></p>
                </div>
            </div>
        </div>

        <!-- Memo Form -->
        <form id="memoForm" class="bg-white shadow-card rounded-xl p-8 transition-all duration-300 hover:shadow-lg">
            <div class="grid grid-cols-1 gap-y-6 gap-x-8 sm:grid-cols-2">
                <!-- Memo Type -->
                <div class="relative">
                    <label for="memoType" class="block text-sm font-medium text-gray-700 mb-1">Document Type <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <select id="memoType" name="memoType" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-sm py-2.5 pl-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200">
                            <option value="">Select Document Type</option>
                            <option value="PO">PO (Provincial Office)</option>
                            <option value="CO">CO (Central Office)</option>
                            <option value="Office Order">Office Order</option>
                            <option value="Advisory">Advisory</option>
                            <option value="Bulletin">Bulletin</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Memo Number (Read-only) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Document Number</label>
                    <div class="flex items-center border border-gray-300 rounded-lg shadow-sm py-2.5 px-3 bg-gray-50">
                        <i data-lucide="hash" class="h-4 w-4 text-gray-400 mr-2"></i>
                        <span id="assignedMemoNumber" class="text-gray-700 font-medium">Select memo type first</span>
                    </div>
                </div>

                <!-- Title -->
                <div class="relative">
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="file-text" class="h-4 w-4 text-gray-400"></i>
                        </div>
                        <input type="text" id="title" name="title" required maxlength="300"
                            class="block w-full border border-gray-300 rounded-lg shadow-sm py-2.5 pl-10 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200"
                            placeholder="Enter memo title">
                        <div class="absolute bottom-2 right-3 text-xs text-gray-500 select-none">
                            <span id="titleCharCount">0</span>/100 characters
                        </div>
                    </div>
                </div>

                <!-- Category -->
                <div class="relative">
                    <label for="signatory" class="block text-sm font-medium text-gray-700 mb-1">Signatory <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <select id="signatory" name="signatory" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-sm py-2.5 pl-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200">
                            <option value="Gamaliel B. Vicente, Jr. CESO III, ASEAN ENG.">Gamaliel B. Vicente, Jr. CESO III, ASEAN ENG.</option>
                            <option value="Jocelyn V. Cabahug">Jocelyn V. Cabahug</option>
                            <option value="Ivy Michelle T. Vasquez">Ivy Michelle T. Vasquez</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Priority -->
                <div class="relative">
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Priority <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <select id="priority" name="priority" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-sm py-2.5 pl-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200">
                            <option value="">Select Priority</option>
                            <option value="High" class="text-red-600">High</option>
                            <option value="Medium" class="text-yellow-600">Medium</option>
                            <option value="Low" class="text-green-600">Low</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Recipients -->
                <div class="relative">
                    <label for="recipients" class="block text-sm font-medium text-gray-700 mb-1">Recipients <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="users" class="h-4 w-4 text-gray-400"></i>
                        </div>
                        <select id="recipients" name="recipients" required
                            class="appearance-none block w-full border border-gray-300 rounded-lg shadow-sm py-2.5 pl-10 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200">
                            <option value="">Select Recipient</option>
                            <option value="ORD">Office of the Regional Director</option>
                            <option value="ROD">Regional Operations Division</option>
                            <option value="FASD">Finance and Administrative Services Division</option>
                            <option value="CO">Central Office</option>
                            <option value="PO">Provincial Office - Cebu</option>
                            <option value="PO">Provincial Office - Bohol</option>
                            <option value="PO">Provincial Office - Siquijor</option>
                            <option value="PO">Provincial Office - Negros Oriental</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i data-lucide="chevron-down" class="h-4 w-4"></i>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="relative col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <textarea id="description" name="description" rows="5" required maxlength="300"
                            class="block w-full border border-gray-300 rounded-lg shadow-sm py-2.5 pl-3 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors duration-200 resize-none"
                            placeholder="Enter memo description"></textarea>
                        <div class="absolute bottom-2 right-3 text-xs text-gray-500 select-none">
                            <span id="descriptionCharCount">0</span>/300 characters
                        </div>
                    </div>
                </div>

            </div>
            <div class="mt-8 flex justify-between items-center">
                <div class="flex gap-4">
                    <button type="button" onclick="window.history.back()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                        class="inline-flex items-center px-5 py-2.5 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        Create Memo
                    </button>
                </div>
                <img src="icons/kayangkaya.png" alt="MBMS Logo" class="h-16 w-auto">
            </div>
        </form>
    </div>

    <script type="module">
        import { createMemo, auth } from './firebase-config.js';
        import { doc, onSnapshot, updateDoc, setDoc, runTransaction, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { db } from './firebase-config.js';

        // Initialize Lucide icons
        lucide.createIcons();

        // Get DOM elements
        const memoForm = document.getElementById('memoForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const assignedMemoNumber = document.getElementById('assignedMemoNumber');
        const memoTypeSelect = document.getElementById('memoType');

        let poNumberRef = null;
        let coNumberRef = null;
        let poUnsubscribe = null;
        let coUnsubscribe = null;

        // Function to update memo number based on type
        function updateMemoNumber(type) {
            // Unsubscribe from previous listeners
            if (poUnsubscribe) poUnsubscribe();
            if (coUnsubscribe) coUnsubscribe();
            if (window.officeOrderUnsubscribe) window.officeOrderUnsubscribe();
            if (window.advisoryUnsubscribe) window.advisoryUnsubscribe();
            if (window.bulletinUnsubscribe) window.bulletinUnsubscribe();

            // Reset the display first
            assignedMemoNumber.textContent = 'Select memo type first';

            if (type === 'PO') {
                poNumberRef = doc(db, "memoNumbers", "current");
                poUnsubscribe = onSnapshot(poNumberRef, (doc) => {
                    if (doc.exists()) {
                        const currentNumber = doc.data().number;
                        assignedMemoNumber.textContent = `${String(currentNumber).padStart(4, '0')}`;
                    }
                });
            } else if (type === 'CO') {
                coNumberRef = doc(db, "memoNumbers", "coCurrent");
                coUnsubscribe = onSnapshot(coNumberRef, async (doc) => {
                    if (!doc.exists()) {
                        try {
                            await updateDoc(coNumberRef, { number: 0 });
                        } catch (error) {
                            await setDoc(coNumberRef, { number: 0 });
                        }
                    } else {
                        const currentNumber = doc.data().number;
                        assignedMemoNumber.textContent = `${String(currentNumber).padStart(4, '0')}`;
                    }
                });
            } else if (type === 'Office Order') {
                const officeOrderRef = doc(db, "memoNumbers", "officeOrder");
                window.officeOrderUnsubscribe = onSnapshot(officeOrderRef, async (doc) => {
                    if (!doc.exists()) {
                        try {
                            await updateDoc(officeOrderRef, { number: 0 });
                        } catch (error) {
                            await setDoc(officeOrderRef, { number: 0 });
                        }
                    } else {
                        const currentNumber = doc.data().number;
                        assignedMemoNumber.textContent = `${String(currentNumber).padStart(4, '0')}`;
                    }
                });
            } else if (type === 'Advisory') {
                const advisoryRef = doc(db, "memoNumbers", "advisory");
                window.advisoryUnsubscribe = onSnapshot(advisoryRef, async (doc) => {
                    if (!doc.exists()) {
                        try {
                            await updateDoc(advisoryRef, { number: 0 });
                        } catch (error) {
                            await setDoc(advisoryRef, { number: 0 });
                        }
                    } else {
                        const currentNumber = doc.data().number;
                        assignedMemoNumber.textContent = `${String(currentNumber).padStart(4, '0')}`;
                    }
                });
            } else if (type === 'Bulletin') {
                const bulletinRef = doc(db, "memoNumbers", "bulletin");
                window.bulletinUnsubscribe = onSnapshot(bulletinRef, async (doc) => {
                    if (!doc.exists()) {
                        try {
                            await updateDoc(bulletinRef, { number: 0 });
                        } catch (error) {
                            await setDoc(bulletinRef, { number: 0 });
                        }
                    } else {
                        const currentNumber = doc.data().number;
                        assignedMemoNumber.textContent = `${String(currentNumber).padStart(4, '0')}`;
                    }
                });
            }
        }

        // Listen for memo type changes
        memoTypeSelect.addEventListener('change', (e) => {
            updateMemoNumber(e.target.value);
        });

        // Handle form submission
        memoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // Show loading overlay
                loadingOverlay.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                successMessage.classList.add('hidden');

                // Get current user
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('User not authenticated');
                }

                // Get form data
                const formData = new FormData(memoForm);
                const userData = JSON.parse(localStorage.getItem('tesdaUser'));
                if (!userData) {
                    throw new Error('User data not found');
                }

                // Get the next memo number
                const memoType = formData.get('memoType');
                let memoNumberKey;
                switch (memoType) {
                    case 'PO':
                        memoNumberKey = 'current';
                        break;
                    case 'CO':
                        memoNumberKey = 'coCurrent';
                        break;
                    case 'Office Order':
                        memoNumberKey = 'officeOrder';
                        break;
                    case 'Advisory':
                        memoNumberKey = 'advisory';
                        break;
                    case 'Bulletin':
                        memoNumberKey = 'bulletin';
                        break;
                    default:
                        throw new Error('Unknown memo type');
                }
                const memoNumberRef = doc(db, "memoNumbers", memoNumberKey);
                const memoNumberDoc = await runTransaction(db, async (transaction) => {
                    const doc = await transaction.get(memoNumberRef);
                    if (!doc.exists()) {
                        transaction.set(memoNumberRef, { number: 1 });
                        return { number: 1 };
                    }
                    const currentNumber = doc.data().number;
                    // Increment the number
                    const nextNumber = currentNumber + 1;
                    transaction.update(memoNumberRef, { number: nextNumber });
                    return { number: nextNumber };
                });

                // Get department code (first 3 letters of department)
                const departmentCode = userData.department.substring(0, 3).toUpperCase();
                const currentYear = new Date().getFullYear();

                // Create memo data object with the assigned number
                const memoData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    department: userData.department,
                    recipients: formData.get('recipients').split(',').map(r => r.trim()),
                    priority: formData.get('priority'),
                    signatory: formData.get('signatory'),
                    createdBy: userData.username,
                    memoType: memoType,
                    memoNumber: `${memoType}-${currentYear}-${departmentCode}-${String(memoNumberDoc.number).padStart(4, '0')}`
                };

                // Create memo
                const memoRef = await createMemo(memoData);
                
                // Log the memo creation
                await logMemoActivity(
                    memoRef.id,
                    `Created Memo ${memoData.memoNumber}`,
                    userData.username
                );

                // Show success message
                successMessage.querySelector('p').textContent = 'Memo created successfully!';
                successMessage.classList.remove('hidden');

                // Reset form
                memoForm.reset();
                assignedMemoNumber.textContent = 'Select memo type first';

                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = userData.department === 'ORD' ? 'ord-dashboard.html' : 'user-dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Error creating memo:', error);
                errorMessage.querySelector('p').textContent = 'Error creating memo. Please try again.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        // Cleanup function
        function cleanup() {
            if (poUnsubscribe) poUnsubscribe();
            if (coUnsubscribe) coUnsubscribe();
        }

        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanup);

        // Add character counter for description
        const descriptionTextarea = document.getElementById('description');
        const descriptionCharCount = document.getElementById('descriptionCharCount');

        descriptionTextarea.addEventListener('input', function() {
            let currentLength = this.value.length;
            if (currentLength > 300) {
                this.value = this.value.slice(0, 300);
                currentLength = 300;
            }
            descriptionCharCount.textContent = currentLength;
            // Add visual feedback when approaching limit
            if (currentLength >= 290) {
                descriptionCharCount.classList.add('text-red-500');
            } else {
                descriptionCharCount.classList.remove('text-red-500');
            }
        });

        // Add character counter for title
        const titleInput = document.getElementById('title');
        const titleCharCount = document.getElementById('titleCharCount');
        titleInput.addEventListener('input', function() {
            let currentLength = this.value.length;
            if (currentLength > 100) {
                this.value = this.value.slice(0, 100);
                currentLength = 100;
            }
            titleCharCount.textContent = currentLength;
            if (currentLength >= 90) {
                titleCharCount.classList.add('text-red-500');
            } else {
                titleCharCount.classList.remove('text-red-500');
            }
        });

        // Add this helper function for logging memo activity
        async function logMemoActivity(memoId, action, username) {
            try {
                const activityRef = doc(collection(db, "memoActivities"));
                await setDoc(activityRef, {
                    memoId: memoId,
                    action: action,
                    username: username,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging memo activity:', error);
            }
        }
    </script>
</body>
</html>
